# Docker Compose
:source-highlighter: pygments
:pygments-style: manni
:icons: font
:figure-caption!:

* https://github.com/bitnami/bitnami-docker-rails[bitnami/bitnami-docker-rails].
* https://zwischenzugs.com/2018/04/23/unprivileged-docker-builds-a-proof-of-concept/[Unprivileged Docker Builds – A Proof of Concept].

## My Rails with PostgreSQL

How to generate a skeletal Rails installation without Ruby installed?

[source,sh]
----
cd rails-pg
# docker build --tag rails-pg .
docker build --no-cache --tag rails-pg .
docker images
----

https://docs.docker.com/engine/reference/builder/[Dockerfile reference].

[source,sh]
.Dockerfile
----
FROM ruby:2.5.0
RUN apt-get update -qq && apt-get install -y build-essential libpq-dev nodejs

RUN gem install rails --version '~> 5.2.0'
RUN rails new myapp --database=postgresql --skip-action-cable --skip-coffee --skip-test --skip-bundle

WORKDIR /myapp

COPY database.yml config

RUN bin/bundle install

COPY Dockerfile .
COPY docker-compose.yml .
----

https://docs.docker.com/compose/compose-file/[Compose file version 3 reference].

[source,sh]
----
version: '3.6'

services:

  db:
    image: postgres:10.3
    volumes:
      - db-data:/var/lib/postgresql/data
  web:
    build: .
    command: bin/rails server --port 3000 --binding '0.0.0.0'
    volumes:
      - .:/myapp
    ports:
      - "3000:3000"
    depends_on:
      - db

volumes:
  db-data:
----


## My Rails with PostgreSQL App

[source,sh]
----
cd ..
docker images
docker run rails-pg
docker ps -a
# quizzical_mccarthy -- container name of the running my-rails-app

rm -rf my-rails-app
docker cp quizzical_mccarthy:/myapp/ my-rails-pg
cd my-rails-app
cp ../my-rails-pg/{Dockerfile,docker-compose.yml} .

docker container rm cocky_hypatia
----


## Docker Compose and Rails – Quickstart

* https://docs.docker.com/compose/rails/[Quickstart: Compose and Rails].

[source,sh]
----
docker-compose build
#
# update docker-compose.yml:
#
# web:
#   # build: .
#   image: my-rails-pg
#
# db uses an image, skipping
# web uses an image, skipping

# docker-compose up
# docker-compose exec web bin/rails db:create

docker-compose run web bin/rails db:create

docker-compose up
# localhost:3000 – Yay! You’re on Rails!

docker compose down
docker compose stop
----

TODO: add new gem: pry-rails, run rails console, migrations










## Images with ENTRYPOINT & CMD

[source,sh]
.Dockerfile
----
# sample Dockerfile with entry point
----

[source,bash]
----
docker run --rm ubuntu-man-git
# nothing appears to happen …

docker run --name command-git --entrypoint git ubuntu-man-git
docker ps -a
docker commit -a "@wbzyl" -m "Set CMD git" command-git ubuntu-git

docker rm -vf command-git

docker run --name command-git ubuntu-git version
#=> git version 2.7.4
----


## Echo server

MacOS, install *netcat*:
[source,sh]
----
brew install netcat
----


### Server

[source,sh]
----
docker container rm $(docker container ls -a -q)
----
