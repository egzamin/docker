# Docker Compose
:source-highlighter: pygments
:pygments-style: manni
:icons: font
:figure-caption!:

* https://github.com/bitnami/bitnami-docker-rails[bitnami/bitnami-docker-rails].
* https://zwischenzugs.com/2018/04/23/unprivileged-docker-builds-a-proof-of-concept/[Unprivileged Docker Builds – A Proof of Concept].

## My Rails with PostgreSQL

[source,sh]
----
cd my-rails-pg
docker build --no-cache --tag my-rails-pg .
docker images
----

[source,sh]
.Dockerfile
----
FROM ruby:2.5.0
RUN apt-get update -qq && apt-get install -y build-essential libpq-dev nodejs

RUN gem install rails pg
RUN rails new myapp --database=postgresql --skip-action-cable --skip-coffee --skip-test --skip-bundle

WORKDIR /myapp

COPY database.yml config

RUN bin/bundle install
----


## My Rails App

[source,sh]
----
cd ..
docker images
docker run docker run my-rails-pg
docker ps -a
# cocky_hypatia -- container name of the running my-rails-app

rm -rf my-rails-app
docker cp cocky_hypatia:/myapp/ my-rails-pg
cd my-rails-app
cp ../my-rails-pg/{Dockerfile,docker-compose.yml} .

docker container rm cocky_hypatia
----


## Docker Compose and Rails – Quickstart

* https://docs.docker.com/compose/rails/[Quickstart: Compose and Rails].

[source,sh]
----
docker-compose build
#
# update docker-compose.yml:
#
# web:
#   # build: .
#   image: my-rails-pg
#
# db uses an image, skipping
# web uses an image, skipping

# docker-compose up
# docker-compose exec web bin/rails db:create

docker-compose run web bin/rails db:create

docker-compose up
# localhost:3000 – Yay! You’re on Rails!

docker compose down
docker compose stop
----

TODO: add new gem: pry-rails, run rails console, migrations










## Images with ENTRYPOINT & CMD

[source,sh]
.Dockerfile
----
# sample Dockerfile with entry point
----

[source,bash]
----
docker run --rm ubuntu-man-git
# nothing appears to happen …

docker run --name command-git --entrypoint git ubuntu-man-git
docker ps -a
docker commit -a "@wbzyl" -m "Set CMD git" command-git ubuntu-git

docker rm -vf command-git

docker run --name command-git ubuntu-git version
#=> git version 2.7.4
----


## Echo server

MacOS, install *netcat*:
[source,sh]
----
brew install netcat
----


### Server

[source,sh]
----
docker container rm $(docker container ls -a -q)
----
